# 电力交易收益最大化 Agent 方案

## 1. 项目目标

本项目旨在基于历史真实电价、日前电价和气象资料，构建一个 Agent 实现电力交易收益最大化。方案将包含电价预测模型和强化学习交易策略，并实现训练、推理和评估流程。

## 2. 数据处理方案

### 2.1 数据来源与预处理

- **标签数据**:
    - 来源: `甘肃统一 结算点价格.xlsx`
    - 处理:
        - 裁剪价格至 40~650 范围。
        - 转换为北京时间 15 分钟粒度。
- **日前价格**:
    - 构建 demo 数据。
- **特征数据 (气象资料)**:
    - 来源: `data/raw/station/hres/results/YYYYMMDD/HH/*.csv` (例如 `20240101/12` 文件夹下的 CSV 文件)。
    - 处理:
        - 转换为北京时间 15 分钟粒度。
        - **时间对齐**: 将特征数据的时间与标签数据对齐。具体为：读取 `YYYYMMDD/HH` (UTC 时间的起报时间) 文件夹下的 CSV 文件，将其中的 `YYYYMMDD 00:00:00 - 23:45:00` (北京时间，相对于第一个行的时间差是 28H-52H) 时间戳对应电价的 `YYYYMMDD 00:00:00 - 23:45:00` (北京时间)。保留分钟的时间戳作为索引。
        - **文件名前缀乱码恢复**: 读取 `point*.csv` 文件时，处理文件名前缀的中文乱码问题。
        - **数据聚合**: 每个日期下有多个 CSV 文件，读取所有 CSV 文件并聚合到最终的 CSV 中，使用文件名中的 `河西point+数字` 或 `河东point+数字` 作为列的前缀。

### 2.2 数据存储

- 处理后的数据将统一存储在 `data/processed/` 目录下。

## 3. 模型构建方案

### 3.1 电价预测模型

- **目标**: 预测未来电价。
- **特征工程**:
    - **时间特征**: 从时间戳中提取小时、星期几、月份、季度等。
    - **滑窗特征**: 基于历史电价和气象数据构建滑窗特征。
    - **Shift 特征**: 构建电价和气象数据的滞后特征。
- **模型选择**: 使用 PyTorch 构建深度学习模型（例如 LSTM、Transformer 或其他序列模型），以捕捉电价和气象数据中的时序依赖关系。

### 3.2 交易 Agent (强化学习)

- **目标**: 实现交易收益最大化。
- **初始条件**: 初始时刻可交易电量为 100 单位。
- **环境定义**:
    - **状态空间**: 包含当前电价、预测电价、历史电价、历史气象数据、当前可交易电量、时间特征等。
    - **动作空间**: 挂单价格（基于预测电价和市场波动）、挂单电量（在可交易电量范围内）。
    - **奖励机制**: 基于交易收益进行设计，鼓励 Agent 做出高收益的交易决策。
- **Agent 选择**: 考虑使用 DDPG、SAC 或 PPO 等主流强化学习算法。

## 4. 训练流程

### 4.1 电价预测模型训练

- **数据准备**: 使用处理后的历史数据进行训练。
- **训练策略**: 采用监督学习方式，优化预测模型的损失函数（如 MSE、MAE）。
- **验证**: 使用验证集评估模型性能，防止过拟合。

### 4.2 交易 Agent 训练

- **环境交互**: Agent 在自定义的电力交易环境中进行交互，通过试错学习优化策略。
- **奖励累积**: Agent 根据交易结果获得奖励，并更新其策略网络。
- **迭代训练**: 持续迭代训练 Agent，直到达到收敛或满足性能要求。

## 5. 推理流程

- **独立推理**: 搭建独立的推理流程，用于实际交易场景。
- **电价预测**: 输入最新的气象数据和历史电价，通过训练好的电价预测模型获取未来电价预测。
- **交易决策**: 将预测电价作为输入之一，通过训练好的交易 Agent 生成交易指令（挂单价格和电量）。

## 6. 测评方案

### 6.1 电价预测模型评估

- **指标**: `abs(pred-tgt)/((pred+target)/2)`，结果裁剪到 0~1。
- **方法**: 在独立的测试集上进行评估。

### 6.2 交易策略评估

- **指标**: 逐日结算一次收益。
- **收益计算**:
    - 如果 `(挂单价格 - 日前价格)` 和 `(真实价格 - 日前价格)` 同号，说明预测正确，`flag = 1`。
    - 如果反号，说明电价预测错误，`flag = -1`。
    - 最终收益为: `单位挂单电量 * (挂单价格 - 日前价格) * flag` 的日积分。
- **方法**: 在模拟交易环境中进行回测，评估 Agent 的长期收益表现。

## 7. 项目结构与规范

- **文件目录**:
    - `docs/`: 存放正式文档。
    - `data/`: 存放原始数据 (`raw/`) 和处理后的数据 (`processed/`)。
    - `script/`: 存放 shell 脚本。
    - `src/`: 存放 Python 源代码。
    - `discuss/`: 存放讨论和评审文档。
    - `logs/`: 存放日志文件。
    - `requirements.txt`: 项目依赖。
    - `README.md`: 项目说明。
    - `GEMINI.md`: 项目规范。
    - `.gitignore`: Git 忽略文件配置。
- **代码规范**:
    - Python 文件行数不超过 300 行。
    - 文件夹中的文件数量不超过 8 个。
    - 强制使用强类型定义。
    - `main.py` 保持简洁。
    - 耗时循环使用 `tqdm` 展示进度条。
    - 日志统一输出到 `logs/app.log`。
    - 遵循优雅的架构设计，避免代码“坏味道”。